<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Converter | Morpha</title>
    
    <link rel="icon" type="image/svg+xml" href="src/svg/m.svg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@pyscript/core/dist/core.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/@pyscript/core/dist/core.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Roboto', 'system-ui', '-apple-system', 'sans-serif'],
                    },
                    colors: {
                        surface: '#f8fafc',
                        'surface-panel': '#ffffff',
                        primary: '#4f46e5', // Indigo 600
                        'primary-hover': '#4338ca', // Indigo 700
                        error: '#ef4444',
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        [x-cloak] { display: none !important; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        
        /* Hide PyScript Loading Overlay/Terminal */
        .py-overlay, py-terminal { display: none !important; }
    </style>
</head>

<body x-data="imageConverter()" x-init="initApp()" 
      @dragover.prevent="isDragging = true"
      class="bg-surface text-slate-900 font-sans min-h-screen overflow-y-auto lg:h-screen lg:overflow-hidden selection:bg-indigo-100 selection:text-indigo-800 relative">

    <script type="py" config='{"packages":["pillow"]}'>
    </script>

    <script type="py">
        import io
        from PIL import Image
        from js import Uint8Array, window
        import pyodide.ffi

        def convert_image_py(data_proxy, format_str):
            try:
                # 1. Convert JS Proxy to Python Bytes
                input_bytes = data_proxy.to_py()
                
                # 2. Open Image in Memory
                img = Image.open(io.BytesIO(input_bytes))
                
                # 3. Handle Palette/Transparency
                if img.mode == "P":
                    img = img.convert("RGBA")
                
                # 4. Handle JPEG specific (Remove Alpha Channel)
                if format_str == "JPEG":
                    img = img.convert("RGB")
                
                # 5. Convert
                output_io = io.BytesIO()
                img.save(output_io, format=format_str)
                output_io.seek(0)
                
                # 6. Return raw bytes back to JS
                return Uint8Array.from_(output_io.read())
                
            except Exception as e:
                print(f"PYTHON ERROR: {e}")
                return None

        window.convertImagePy = convert_image_py
        window.pythonEngineReady = True
    </script>

    <div x-show="isDragging" 
         x-transition.opacity 
         @dragleave.prevent="isDragging = false"
         @drop.prevent="handleDrop($event)"
         class="fixed inset-0 z-[100] bg-indigo-600/90 backdrop-blur-sm border-[6px] border-white/20 m-4 rounded-[32px] flex items-center justify-center"
         x-cloak>
        <div class="bg-white p-10 rounded-[32px] shadow-2xl flex flex-col items-center animate-bounce pointer-events-none">
            <div class="bg-indigo-100 p-5 rounded-full mb-5">
                <i data-lucide="download-cloud" class="w-12 h-12 text-indigo-600"></i>
            </div>
            <span class="text-2xl font-bold text-slate-800">Drop images here</span>
            <span class="text-sm text-slate-500 mt-2 font-medium">Add to queue</span>
        </div>
    </div>

    <div class="lg:h-full h-auto flex flex-col max-w-7xl mx-auto p-4 lg:p-6 gap-4 lg:gap-6 relative z-10">

        <header class="flex items-center justify-between shrink-0 py-1">
            <div class="flex items-center gap-4">
                <div class="w-[100px] h-[100px] flex items-center justify-center shrink-0">
                    <img src="src/svg/morpha.svg" alt="Morpha Logo" class="w-full h-full object-contain">
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight text-slate-900">Image Converter</h1>
                </div>
            </div>
            <div class="hidden md:flex items-center gap-2 px-4 py-2 bg-white rounded-full border border-slate-200 shadow-sm">
                <div class="flex items-center gap-2 mr-4 border-r border-slate-200 pr-4">
                    <span class="relative flex h-2.5 w-2.5">
                      <span x-show="!pythonReady" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-orange-400 opacity-75"></span>
                      <span :class="pythonReady ? 'bg-green-500' : 'bg-orange-500'" class="relative inline-flex rounded-full h-2.5 w-2.5"></span>
                    </span>
                    <span class="text-xs font-medium text-slate-500" x-text="pythonReady ? 'Engine Ready' : 'Loading Engine...'"></span>
                </div>
                
                <i data-lucide="shield-check" class="w-4 h-4 text-green-600"></i>
                <span class="text-xs text-slate-600 font-medium">All processing is done locally in your browser.</span>
            </div>
        </header>

        <section class="shrink-0 grid grid-cols-1 md:grid-cols-4 gap-4">
            <button @click="$refs.fileInput.click()" class="group relative flex flex-col items-center justify-center gap-3 p-5 bg-white hover:bg-indigo-50/50 border border-slate-200 hover:border-indigo-200 rounded-2xl shadow-sm hover:shadow-md transition-all duration-200 text-center h-full">
                <div class="w-12 h-12 rounded-full bg-indigo-50 group-hover:bg-white shadow-sm flex items-center justify-center text-indigo-600 transition-colors">
                    <i data-lucide="image-plus" class="w-6 h-6"></i>
                </div>
                <div class="flex flex-col gap-0.5">
                    <span class="text-sm font-semibold text-slate-800">Select Images</span>
                    <span class="text-[11px] text-slate-500 font-medium">All Standard Formats</span>
                </div>
                <input x-ref="fileInput" type="file" accept="image/*" multiple hidden @change="handleFiles($event.target.files)">
            </button>

            <button @click="$refs.folderInput.click()" class="group relative flex flex-col items-center justify-center gap-3 p-5 bg-white hover:bg-indigo-50/50 border border-slate-200 hover:border-indigo-200 rounded-2xl shadow-sm hover:shadow-md transition-all duration-200 text-center h-full">
                <div class="w-12 h-12 rounded-full bg-indigo-50 group-hover:bg-white shadow-sm flex items-center justify-center text-indigo-600 transition-colors">
                    <i data-lucide="folder-input" class="w-6 h-6"></i>
                </div>
                <div class="flex flex-col gap-0.5">
                    <span class="text-sm font-semibold text-slate-800">Select Folder</span>
                    <span class="text-[11px] text-slate-500 font-medium">Recursive Import</span>
                </div>
                <input x-ref="folderInput" type="file" webkitdirectory directory hidden @change="handleFiles($event.target.files, 'folder')">
            </button>

            <div class="md:col-span-2 flex flex-col h-full bg-white border border-slate-200 rounded-2xl shadow-sm p-4 gap-4">
                <div class="h-12 bg-slate-50 rounded-xl border border-slate-200 flex items-center p-1 gap-2 focus-within:border-indigo-500 focus-within:bg-white transition-all shrink-0">
                    <div class="pl-3 text-slate-400">
                        <i data-lucide="link" class="w-5 h-5"></i>
                    </div>
                    <input type="text" x-model="urlInput" autocomplete="off" spellcheck="false" @keydown.enter="addUrl()" placeholder="Paste image URL here..." class="flex-1 bg-transparent border-none outline-none focus:ring-0 focus:outline-none text-sm text-slate-800 placeholder:text-slate-400 font-medium h-full">
                    <button @click="addUrl()" class="h-full px-5 bg-slate-900 hover:bg-primary text-white text-xs font-bold uppercase tracking-wide rounded-lg shadow transition-colors flex items-center gap-2">
                        Fetch
                    </button>
                </div>

                <div class="flex-1 flex flex-col items-center justify-center gap-2 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50 hover:bg-indigo-50/30 hover:border-indigo-200 transition-colors p-2 text-center group">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-semibold text-slate-500 group-hover:text-indigo-600 transition-colors">Paste the image here</span>
                        <button @click="pasteFromClipboard()" class="flex items-center gap-1.5 px-3 py-1.5 bg-white border border-slate-200 hover:border-indigo-300 hover:text-indigo-600 text-slate-600 text-xs font-bold rounded-full shadow-sm transition-all active:scale-95">
                            <i data-lucide="clipboard-paste" class="w-3.5 h-3.5"></i>
                            Clipboard
                        </button>
                    </div>
                    <span class="text-[11px] text-slate-400 font-medium">or drag and drop your images anywhere on screen...</span>
                </div>
            </div>
        </section>

        <section class="shrink-0 flex flex-wrap items-center justify-between gap-4 px-1">
            <div class="flex items-center gap-3 bg-white border border-slate-200 p-1.5 pr-4 rounded-full shadow-sm">
                <span class="bg-slate-100 px-3 py-1.5 rounded-full text-xs font-semibold text-slate-700 border border-slate-200">Global Output Format</span>
                <select x-model="globalFormat" class="bg-transparent border-none text-sm font-semibold text-slate-800 focus:ring-0 cursor-pointer py-1 pl-2 pr-8 outline-none">
                    <optgroup label="Web Standard (Fast)">
                        <option value="JPEG">JPEG</option>
                        <option value="PNG">PNG</option>
                        <option value="WEBP">WebP</option>
                    </optgroup>
                    <optgroup label="Advanced (Python)">
                        <option value="BMP">BMP</option>
                        <option value="TIFF">TIFF</option>
                        <option value="ICO">ICO</option>
                        <option value="PPM">PPM</option>
                        <option value="TGA">TGA</option>
                    </optgroup>
                </select>
            </div>
        </section>

        <div class="lg:flex-1 lg:min-h-0 flex-none h-auto grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6 pb-4 lg:pb-0">
            
            <div class="flex flex-col bg-white border border-slate-200 rounded-[20px] shadow-soft overflow-hidden h-[500px] lg:h-auto">
                <div class="p-4 flex items-center justify-between border-b border-slate-100">
                    <h2 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                        Input Queue
                        <span x-show="queue.length > 0" class="bg-slate-100 border border-slate-200 text-slate-600 text-[10px] px-2 py-0.5 rounded-full font-mono" x-text="queue.length"></span>
                    </h2>
                    <div class="flex gap-2">
                        <button x-show="queue.length" @click="clearQueue()" class="flex items-center gap-2 px-3 py-2 hover:bg-red-50 text-red-600 text-xs font-semibold rounded-lg transition-colors group" title="Clear All">
                            <i data-lucide="trash-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                            Remove All
                        </button>
                        <button x-show="queue.length" @click="convertAll()" class="flex items-center gap-2 px-4 py-2 bg-primary hover:bg-primary-hover text-white text-sm font-medium rounded-lg shadow-md shadow-indigo-200 transition-all active:scale-95">
                            <i data-lucide="zap" class="w-5 h-5"></i>
                            Convert All
                        </button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-2 bg-slate-50/50">
                    <div x-show="queue.length === 0" class="h-full flex flex-col items-center justify-center text-slate-400 gap-4 min-h-[200px]">
                        <div class="w-20 h-20 rounded-3xl bg-slate-100 border border-slate-200 flex items-center justify-center">
                            <i data-lucide="image" class="w-10 h-10 opacity-40"></i>
                        </div>
                        <p class="text-sm font-medium text-slate-500">No images selected</p>
                    </div>

                    <template x-for="item in queue" :key="item.id">
                        <div class="group bg-white border border-slate-200 p-2 rounded-xl flex items-center gap-3 shadow-sm">
                            <button @click="removeQueueItem(item.id)" class="w-10 h-10 shrink-0 flex items-center justify-center rounded-lg hover:bg-red-50 text-slate-400 hover:text-error transition-colors">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                            <div class="w-12 h-12 shrink-0 bg-slate-100 rounded-lg overflow-hidden relative border border-slate-200">
                                <img :src="item.url" class="w-full h-full object-cover">
                                <div x-show="item.isProcessing" class="absolute inset-0 bg-black/40 flex items-center justify-center backdrop-blur-[1px]">
                                    <i data-lucide="loader-2" class="w-5 h-5 text-white animate-spin"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0 mr-2 relative">
                                <div class="inline-grid items-center justify-start max-w-[7rem] sm:max-w-[10rem] overflow-hidden">
                                    <span class="col-start-1 row-start-1 opacity-0 pointer-events-none whitespace-pre px-1 font-bold text-sm" x-text="item.baseName"></span>
                                    <input type="text" x-model="item.baseName" autocomplete="off" spellcheck="false" class="col-start-1 row-start-1 w-full min-w-[2rem] bg-transparent border-b-2 border-transparent hover:border-slate-200 focus:border-primary focus:outline-none text-sm font-bold text-slate-800 px-1 pb-0.5 transition-colors placeholder-slate-300 truncate" placeholder="Name">
                                </div>
                                <div class="flex items-center gap-2 text-[11px] text-slate-500 mt-1 pl-1">
                                    <span class="font-medium" x-text="formatBytes(item.size)"></span>
                                    <span class="text-slate-300">|</span>
                                    <span class="shrink-0 bg-slate-100 border border-slate-200 text-slate-600 text-[10px] px-1.5 py-0.5 rounded font-mono lowercase" x-text="item.ext"></span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 pl-2 border-l border-slate-100 shrink-0">
                                <select x-model="item.targetFormat" class="w-[4.5rem] bg-slate-50 hover:bg-slate-100 border border-transparent text-[11px] font-bold text-slate-600 rounded-lg py-1.5 pl-1 focus:ring-0 cursor-pointer transition-colors outline-none">
                                    <option value="global">Global</option>
                                    <option value="JPEG">JPEG</option>
                                    <option value="PNG">PNG</option>
                                    <option value="WEBP">WebP</option>
                                    <option value="BMP">BMP</option>
                                    <option value="TIFF">TIFF</option>
                                    <option value="ICO">ICO</option>
                                </select>
                                <button @click="convertItem(item)" :disabled="item.isProcessing" class="w-9 h-9 shrink-0 flex items-center justify-center rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white disabled:opacity-50 disabled:hover:bg-indigo-50 disabled:hover:text-indigo-600 transition-all">
                                    <i data-lucide="play" class="w-5 h-5 fill-current"></i>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="flex flex-col bg-white border border-slate-200 rounded-[20px] shadow-soft overflow-hidden h-[500px] lg:h-auto">
                <div class="p-4 flex items-center justify-between border-b border-slate-100">
                    <h2 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                        Converted
                        <span x-show="results.length > 0" class="bg-green-50 border border-green-200 text-green-700 text-[10px] px-2 py-0.5 rounded-full font-mono" x-text="results.length"></span>
                    </h2>
                    <div class="flex gap-2">
                         <button x-show="results.length" @click="clearResults()" class="flex items-center gap-2 px-3 py-2 hover:bg-red-50 text-red-600 text-xs font-semibold rounded-lg transition-colors group" title="Clear All">
                            <i data-lucide="trash-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                            Remove All
                        </button>
                        <button x-show="results.length" @click="downloadZip()" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 text-sm font-medium rounded-lg shadow-sm transition-all">
                            <i data-lucide="archive" class="w-5 h-5 text-slate-500"></i>
                            Download ZIP
                        </button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-2 bg-slate-50/50">
                    <div x-show="results.length === 0" class="h-full flex flex-col items-center justify-center text-slate-400 gap-4 min-h-[200px]">
                        <div class="w-20 h-20 rounded-3xl bg-slate-100 border border-slate-200 flex items-center justify-center">
                            <i data-lucide="check-circle-2" class="w-10 h-10 opacity-40"></i>
                        </div>
                        <p class="text-sm font-medium text-slate-500">Converted images appear here</p>
                    </div>

                    <template x-for="file in results" :key="file.id">
                        <div class="group bg-white border border-green-200 p-2 rounded-xl flex items-center gap-3 shadow-sm hover:shadow-md hover:border-green-300 transition-all">
                            <button @click="removeResult(file.id)" class="w-10 h-10 shrink-0 flex items-center justify-center rounded-lg hover:bg-red-50 text-slate-400 hover:text-error transition-colors">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                            <div class="w-12 h-12 shrink-0 bg-white rounded-lg overflow-hidden relative border border-green-200 p-0.5">
                                <img :src="file.url" class="w-full h-full object-cover rounded-[6px]">
                                <div class="absolute bottom-0 right-0 bg-green-500 w-4 h-4 rounded-tl-md flex items-center justify-center">
                                    <i data-lucide="check" class="w-2.5 h-2.5 text-white font-bold"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0 mr-2 relative">
                                <div class="inline-grid items-center justify-start max-w-[7rem] sm:max-w-[10rem] overflow-hidden">
                                    <span class="col-start-1 row-start-1 opacity-0 pointer-events-none whitespace-pre px-1 font-bold text-sm" x-text="file.baseName"></span>
                                    <input type="text" x-model="file.baseName" autocomplete="off" spellcheck="false" class="col-start-1 row-start-1 w-full min-w-[2rem] bg-transparent border-b-2 border-transparent hover:border-green-300 focus:border-green-500 focus:outline-none text-sm font-bold text-slate-800 px-1 pb-0.5 transition-colors placeholder-slate-300 truncate" placeholder="Name">
                                </div>
                                <div class="flex items-center gap-2 text-[11px] text-slate-500 mt-1 pl-1">
                                    <span class="font-medium" x-text="formatBytes(file.blob.size)"></span>
                                    <span class="text-slate-300">|</span>
                                    <span class="shrink-0 bg-green-50 border border-green-100 text-green-700 text-[10px] px-1.5 py-0.5 rounded font-mono lowercase" x-text="file.ext"></span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 pl-2 border-l border-green-100 shrink-0">
                                <button @click="downloadItem(file)" title="Download" class="w-9 h-9 shrink-0 flex items-center justify-center rounded-lg bg-white border border-slate-200 hover:border-green-400 text-slate-600 hover:text-green-600 hover:shadow-sm transition-all">
                                    <i data-lucide="download" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <script>
        function imageConverter() {
            return {
                queue: [],      
                results: [],    
                urlInput: '',
                globalFormat: 'JPEG',
                isDragging: false,
                pythonReady: false,
                
                // Browser Preview Support
                allowedMimes: ['image/jpeg', 'image/png', 'image/webp', 'image/gif', 'image/avif', 'image/bmp', 'image/x-icon'],
                
                // Maps Formats to Extensions
                formatExtensions: {
                    'JPEG': '.jpg', 'PNG': '.png', 'WEBP': '.webp',
                    'BMP': '.bmp', 'TIFF': '.tiff', 'ICO': '.ico',
                    'PPM': '.ppm', 'TGA': '.tga'
                },

                initApp() {
                    const refresh = () => this.$nextTick(() => lucide.createIcons());
                    this.$watch('queue.length', refresh);
                    this.$watch('results.length', refresh);
                    window.addEventListener('paste', (e) => this.handlePaste(e));
                    
                    // Poll for Python Readiness
                    const checkPython = setInterval(() => {
                        if (window.pythonEngineReady) {
                            this.pythonReady = true;
                            clearInterval(checkPython);
                        }
                    }, 500);
                    
                    lucide.createIcons();
                },

                // --- Helpers ---
                idGen() { return Math.random().toString(36).substr(2, 9); },
                
                formatBytes(bytes, decimals = 1) {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const dm = decimals < 0 ? 0 : decimals;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
                },

                validateFile(file) {
                    return file && this.allowedMimes.includes(file.type);
                },

                splitName(fullFilename) {
                    const i = fullFilename.lastIndexOf('.');
                    if (i === -1) return { base: fullFilename, ext: '' };
                    return { base: fullFilename.substring(0, i), ext: fullFilename.substring(i) };
                },

                getUniqueNameParts(baseName, extension, list) {
                    let newBase = baseName;
                    let counter = 1;
                    const fullExt = extension.startsWith('.') ? extension : '.' + extension;
                    const isTaken = (name) => list.some(item => (item.baseName.toLowerCase() === name.toLowerCase()) && (item.ext.toLowerCase() === fullExt.toLowerCase()));
                    while (isTaken(newBase)) { newBase = `${baseName} (${counter})`; counter++; }
                    return newBase;
                },

                getUniqueInputName(baseName, extension, list) {
                      let newBase = baseName;
                      let counter = 1;
                      const getFull = (b, e) => (b + e).toLowerCase();
                      const target = (extension || '').toLowerCase();
                      while (list.some(item => getFull(item.baseName, item.ext) === getFull(newBase, target))) { newBase = `${baseName} (${counter})`; counter++; }
                      return newBase;
                },

                // --- Input Logic ---
                addFileToQueue(file, source = 'file') {
                    if (!this.validateFile(file)) {
                        console.warn("Unsupported Input Format:", file.type);
                        return;
                    }
                    
                    const { base, ext } = this.splitName(file.name);
                    const uniqueBase = this.getUniqueInputName(base, ext, this.queue);
                    const id = this.idGen();
                    const url = URL.createObjectURL(file);
                    
                    this.queue.push({
                        id,
                        baseName: uniqueBase, 
                        ext: ext,             
                        file: file,
                        url,
                        size: file.size,
                        type: file.type,
                        isProcessing: false,
                        targetFormat: 'global',
                    });
                },

                handleFiles(fileList, source = 'file') {
                    Array.from(fileList).forEach(f => this.addFileToQueue(f, source));
                    if(this.$refs.fileInput) this.$refs.fileInput.value = '';
                    if(this.$refs.folderInput) this.$refs.folderInput.value = '';
                },

                async addUrl() {
                    if (!this.urlInput) return;
                    const u = this.urlInput;
                    this.urlInput = 'Fetching...';
                    const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(u);

                    try {
                        const res = await fetch(proxyUrl); 
                        if (!res.ok) throw new Error('Network error');
                        const blob = await res.blob();
                        if (!this.validateFile(blob)) throw new Error(`Unsupported image type: ${blob.type}`);
                        
                        const name = new URL(u).pathname.split('/').pop() || 'remote-image.jpg';
                        const file = new File([blob], name, { type: blob.type });
                        this.addFileToQueue(file, 'url');
                        this.urlInput = '';
                    } catch (e) {
                        alert(`Could not add image: ${e.message}`);
                        this.urlInput = u;
                    }
                },

                async pasteFromClipboard() {
                    try {
                        const items = await navigator.clipboard.read();
                        let foundImage = false;
                        for (const item of items) {
                             const imageType = item.types.find(type => this.allowedMimes.includes(type));
                             if (imageType) {
                                 const blob = await item.getType(imageType);
                                 const ext = '.' + (imageType.split('/')[1] || 'png');
                                 const file = new File([blob], `clipboard_image${ext}`, { type: imageType });
                                 this.addFileToQueue(file, 'clipboard');
                                 foundImage = true;
                             }
                        }
                        if (!foundImage) alert("No supported images found in clipboard.");
                    } catch (err) {
                        console.error(err);
                        alert('Clipboard access denied. Try using Ctrl+V.');
                    }
                },

                async handlePaste(e) {
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (const item of items) {
                        if (item.kind === 'file') {
                            const blob = item.getAsFile();
                            if (this.validateFile(blob)) {
                                const ext = '.' + (blob.type.split('/')[1] || 'png');
                                const file = new File([blob], `pasted_image${ext}`, { type: blob.type });
                                this.addFileToQueue(file, 'clipboard');
                            }
                        }
                    }
                },

                handleDrop(e) {
                    this.isDragging = false;
                    const items = e.dataTransfer.items;
                    
                    const traverse = async (entry) => {
                        if (entry.isFile) {
                            await new Promise(resolve => entry.file(f => {
                                if (this.validateFile(f)) this.addFileToQueue(f, 'dragdrop');
                                resolve();
                            }));
                        } else if (entry.isDirectory) {
                            const reader = entry.createReader();
                            const entries = await new Promise(resolve => reader.readEntries(resolve));
                            for (const sub of entries) await traverse(sub);
                        }
                    };

                    if (items && items[0] && items[0].webkitGetAsEntry) {
                        for (const item of items) {
                            const entry = item.webkitGetAsEntry();
                            if (entry) traverse(entry);
                        }
                    } else {
                        Array.from(e.dataTransfer.files).forEach(f => {
                            if (this.validateFile(f)) this.addFileToQueue(f, 'dragdrop');
                        });
                    }
                },

                // --- Conversion Logic ---

                async convertItem(item) {
                    if (item.isProcessing) return;
                    item.isProcessing = true;

                    // Determine Target Format
                    const targetFormat = item.targetFormat === 'global' ? this.globalFormat : item.targetFormat;
                    
                    // Standard formats that Canvas can handle efficiently
                    const isStandardFormat = ['JPEG', 'PNG', 'WEBP'].includes(targetFormat);

                    try {
                        let blob = null;
                        
                        // 1. Fast Path: Browser Canvas
                        if (isStandardFormat) {
                            const img = new Image();
                            img.crossOrigin = "anonymous"; 
                            await new Promise((resolve, reject) => {
                                img.onload = resolve;
                                img.onerror = reject;
                                img.src = item.url;
                            });

                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');

                            if (targetFormat === 'JPEG') {
                                ctx.fillStyle = '#ffffff';
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                            }
                            ctx.drawImage(img, 0, 0);
                            
                            // Canvas to Blob
                            blob = await new Promise(resolve => canvas.toBlob(resolve, `image/${targetFormat.toLowerCase()}`, 0.92));
                        
                        // 2. Power Path: Python Pillow
                        } else {
                            if (!this.pythonReady) throw new Error("Python engine is loading. Please wait...");
                            
                            // Fetch bytes
                            const response = await fetch(item.url);
                            const buffer = await response.arrayBuffer();
                            const uint8Array = new Uint8Array(buffer);
                            
                            // Execute Python Conversion
                            const resultBytes = window.convertImagePy(uint8Array, targetFormat);
                            
                            if (resultBytes) {
                                // Convert result back to Blob
                                let mimeType = `image/${targetFormat.toLowerCase()}`;
                                if (targetFormat === 'ICO') mimeType = 'image/x-icon';
                                blob = new Blob([resultBytes], { type: mimeType });
                            } else {
                                throw new Error("Python conversion returned no data.");
                            }
                        }

                        if (!blob) throw new Error("Conversion failed");

                        const currentBaseName = item.baseName || 'untitled';
                        const ext = this.formatExtensions[targetFormat] || '.bin';
                        const finalBaseName = this.getUniqueNameParts(currentBaseName, ext, this.results);
                        const resultUrl = URL.createObjectURL(blob);

                        this.results.push({
                            id: this.idGen(),
                            sourceId: item.id,
                            baseName: finalBaseName, 
                            ext: ext,                 
                            blob: blob,
                            url: resultUrl,
                            format: targetFormat
                        });

                    } catch (error) {
                        console.error("Conversion error:", error);
                        alert(`Failed to convert ${item.baseName}: ${error.message}`);
                    } finally {
                        item.isProcessing = false;
                    }
                },

                async convertAll() {
                    for (const item of this.queue) {
                        await this.convertItem(item);
                    }
                },

                // --- UI Helpers ---
                removeQueueItem(id) {
                    const idx = this.queue.findIndex(i => i.id === id);
                    if (idx > -1) { URL.revokeObjectURL(this.queue[idx].url); this.queue.splice(idx, 1); }
                },
                removeResult(id) {
                    const idx = this.results.findIndex(i => i.id === id);
                    if (idx > -1) { URL.revokeObjectURL(this.results[idx].url); this.results.splice(idx, 1); }
                },
                clearQueue() { this.queue.forEach(i => URL.revokeObjectURL(i.url)); this.queue = []; },
                clearResults() { this.results.forEach(i => URL.revokeObjectURL(i.url)); this.results = []; },

                downloadItem(item) {
                    const a = document.createElement('a');
                    a.href = item.url;
                    a.download = item.baseName + item.ext;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                },

                async downloadZip() {
                    if (!this.results.length) return;
                    const zip = new JSZip();
                    this.results.forEach(f => zip.file(f.baseName + f.ext, f.blob));
                    const content = await zip.generateAsync({ type: 'blob' });
                    const url = URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'images.zip';
                    document.body.appendChild(a); a.click();
                    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
                }
            }
        }
    </script>
    
    <script data-goatcounter="https://morpha.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>
